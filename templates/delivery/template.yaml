version: 1
name: Delivery Pipeline
displayName: Delivery Pipeline
description: Pipeline for building, scanning, and publishing a container image.
type: pipeline-template
parameters:
  - name: default_image
    displayName: Image
    description: The fully qualified container image name (including the registry).
    type: string
    defaultValue: "docker.io/my-app"
  - name: default_tag
    displayName: Image Tag
    type: string
    defaultValue: "latest"
  - name: image_registry_auth_json
    displayName: JSON File Docker Config for Authentication (Secret File)
    type: credentials
  - name: default_build_args
    displayName: Build Arguments
    description: "A JSON object of build arguments to pass to the container build process."
    type: string
    defaultValue: "{}"
  - name: default_build_dir
    displayName: Build Directory
    description: "The directory to use as the build context for the container build."
    type: string
    defaultValue: "."
  - name: default_dockerfile
    displayName: Dockerfile
    type: string
    defaultValue: "Dockerfile"
  - name: default_build_target
    displayName: Build Target
    description: "The build target to use when building the container image (for use with multi-stage Dockerfiles)."
    type: string
  - name: default_kaniko_memory_limit
    displayName: Kaniko Memory Limit
    description: "Kaniko memory limit input for those larger builds."
    defaultValue: "1Gi"
    type: string
  - name: default_platform
    displayName: Platform
    description: "A comma separated list of platforms to build the container image for (e.g., linux/amd64,linux/arm64)."
    type: string
    defaultValue: "linux/amd64"
  - name: default_arch
    displayName: Architecture
    description: "The architecture to build the container image for (e.g., amd64,arm64)."
    type: string
    defaultValue: "amd64"
  - name: copy_artifacts_job_name
    displayName: Copy Artifacts Job Name
    description: "The Jenkins job name from which to copy artifacts."
    type: string
    defaultValue: ""
  - name: copy_artifacts_build_number
    displayName: Copy Artifacts Build Number
    description: "The specific build number from which to copy artifacts. Should be provided by upstream job."
    type: string
    defaultValue: ""
  - name: copy_artifacts_filter
    displayName: Copy Artifacts Filter
    description: "The file filter identifying which artifacts to copy."
    type: string
    defaultValue: ""        
  - name: enable_ansi_colors
    displayName: Enable ANSI Colors
    description: "Enable ANSI color output in the Jenkins console (requires AnsiColor plugin)."
    type: boolean
    defaultValue: true
  - name: default_image_push_enabled
    displayName: Enable Image Push
    description: "Enable the image push step."
    type: boolean
    defaultValue: false
  - name: default_update_latest
    displayName: Update Latest Image Tag
    description: "When true, update the latest tag to point to the newly built image."
    type: boolean
    defaultValue: false
  - name: default_enable_cache
    displayName: Enable Image Build Caching
    description: "Enable Kaniko image build cache."
    type: boolean
    defaultValue: false
  - name: default_enable_snyk
    displayName: Enable Snyk Scan
    description: "Enable the Snyk container image vulnerability scan step."
    type: boolean
    defaultValue: false
  - name: snyk_token
    displayName: Snyk API Token
    description: "The Snyk API token to use for scanning the container image."
    type: credentials
  - name: default_snyk_project_name
    displayName: Snyk Project Name
    description: "The name of the Snyk project to associate the container image scan with."
    type: string
    defaultValue: "my-app"
  - name: default_vulnerability_severity_threshold
    displayName: Vulnerability Severity Threshold
    description: "The minimum severity level of vulnerabilities which will cause the build to fail if detected (options: low, medium, high, critical)."
    type: string
    defaultValue: "high"
  - name: sbom_format
    displayName: SBOM Format
    description: "The SBOM format to produce (cyclonedx1.4+json, cyclonedx1.4+xml, [cyclonedx1.5+json], cyclonedx1.5+xml, or spdx2.3+json)"
    type: string
    defaultValue: "cyclonedx1.5+json"
  - name: build_retention_days
    displayName: Build Log Retention Days
    description: "The number of days to retain build logs and artifacts."
    type: string
    defaultValue: "90"
  - name: build_retention_count
    displayName: Build Log Retention Count
    description: "The number of builds to retain."
    type: string
    defaultValue: "1000"
